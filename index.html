<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <meta name="theme-color" content="#0f172a" />
    <title>AI Billboard Scanner â€¢ SF Culture Replacer</title>
    <meta name="description" content="Point your phone at AI billboards to reveal authentic neighborhood stories and culture." />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

    <style>
      :root {
        --bg: #0b1020;
        --panel: #111827;
        --text: #e5e7eb;
        --muted: #94a3b8;
        --accent: #a3e635;
        --accent-2: #22d3ee;
        --danger: #ef4444;
      }

      html, body {
        height: 100%;
        width: 100%;
        margin: 0;
        padding: 0;
        background: var(--bg);
        color: var(--text);
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        overflow-x: hidden;
        box-sizing: border-box;
      }

      /* Full-screen camera */
      video#camera {
        position: fixed;
        inset: 0;
        width: 100vw;
        height: 100vh;
        object-fit: cover;
        transform: scaleX(-1);
        z-index: 0;
        background: #000;
      }

      /* Top overlay logo */
      .logo-overlay {
        position: fixed;
        top: calc(env(safe-area-inset-top) + 16px);
        left: 50%;
        transform: translateX(-50%);
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .logo-fallback {
        background: var(--accent);
        color: #000;
        padding: 15px 30px;
        border-radius: 8px;
        font-size: 18px;
        font-weight: bold;
        text-align: center;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      }

      /* Bottom overlay controls */
      .overlay-bottom {
        position: fixed;
        left: 0; right: 0; bottom: 0;
        z-index: 50;
        padding: 4px 8px calc(4px + env(safe-area-inset-bottom));
        display: grid;
        gap: 4px;
        background: transparent;
      }

      .status {
        text-align: center;
        color: rgba(255,255,255,0.8);
        font-size: 0.85rem;
        min-height: 1.2em;
        text-shadow: 0 1px 3px rgba(0,0,0,0.7);
      }

      .scan-btn {
        justify-self: center;
        width: min(85vw, 280px);
        padding: 10px 12px;
        border-radius: 50px;
        border: 1px solid rgba(255,255,255,0.2);
        background: rgba(0,0,0,0.4);
        backdrop-filter: blur(8px);
        color: white;
        font-weight: 700;
        font-size: 0.9rem;
        text-shadow: 0 1px 2px rgba(0,0,0,0.8);
        cursor: pointer;
      }

      .scan-btn:disabled { 
        opacity: 0.6; 
        cursor: not-allowed;
      }

      .spinner { 
        display: inline-block; 
        width: 16px; 
        height: 16px; 
        border: 2px solid rgba(255,255,255,0.3); 
        border-top-color: var(--accent); 
        border-radius: 50%; 
        animation: spin 1s linear infinite; 
      }

      @keyframes spin { 
        to { transform: rotate(360deg); } 
      }

      /* Neighborhood Billboard Overlay */
      .billboard-overlay {
        position: fixed;
        inset: 0;
        z-index: 9999;
        background: rgba(0, 0, 0, 0.9);
        backdrop-filter: blur(10px);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        opacity: 0;
        visibility: hidden;
        pointer-events: none;
        transition: opacity 400ms ease, visibility 400ms ease;
      }

      .billboard-overlay.show {
        opacity: 1;
        visibility: visible;
        pointer-events: auto;
      }

      .billboard-content {
        text-align: center;
        animation: slideUp 600ms cubic-bezier(0.22, 0.9, 0.3, 1);
      }

      .billboard-image {
        max-width: 90vw;
        max-height: 60vh;
        width: auto;
        height: auto;
        border-radius: 12px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
        margin-bottom: 20px;
      }

      .billboard-neighborhood {
        font-size: 28px;
        font-weight: bold;
        color: var(--accent);
        text-shadow: 0 2px 8px rgba(0, 0, 0, 0.8);
        margin-bottom: 30px;
      }

      .billboard-close {
        position: absolute;
        top: 30px;
        right: 30px;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.9);
        border: none;
        font-size: 20px;
        font-weight: bold;
        color: #333;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      }

      .billboard-close:hover {
        background: white;
        transform: scale(1.1);
      }

      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(50px) scale(0.95);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      /* Dev test buttons */
      .dev-test-buttons {
        margin-top: 8px;
        display: flex;
        gap: 4px;
        flex-wrap: wrap;
        justify-content: center;
      }

      .dev-test-buttons button {
        padding: 4px 8px;
        font-size: 12px;
        border-radius: 6px;
        border: 1px solid;
        cursor: pointer;
        background: rgba(255,255,255,0.1);
        color: white;
      }

      .visually-hidden {
        position: absolute !important;
        height: 1px; width: 1px;
        overflow: hidden;
        clip: rect(1px, 1px, 1px, 1px);
        white-space: nowrap;
      }

      /* Responsive adjustments */
      @media (max-width: 768px) {
        .billboard-neighborhood {
          font-size: 24px;
        }
        
        .billboard-close {
          top: 20px;
          right: 20px;
          width: 35px;
          height: 35px;
          font-size: 18px;
        }
      }
    </style>
  </head>
  <body>
    <!-- Full-screen camera feed -->
    <video id="camera" playsinline autoplay muted></video>

    <!-- Top overlay logo -->
    <div class="logo-overlay">
      <div class="logo-fallback">YOUR LOGO</div>
    </div>

    <!-- Bottom overlay controls -->
    <div class="overlay-bottom">
      <div class="status" id="status">Requesting cameraâ€¦</div>
      <button id="btnScan" class="scan-btn" disabled>ðŸ“¸ Scan the Billboard</button>
      
      <!-- Developer test buttons -->
      <div class="dev-test-buttons">
        <button onclick="testNeighborhood('Mission District')">Test Mission</button>
        <button onclick="testNeighborhood('SOMA')">Test SOMA</button>
        <button onclick="testNeighborhood('Castro')">Test Castro</button>
        <button onclick="testNeighborhood('Marina')">Test Marina</button>
        <button onclick="testNeighborhood('Mission Bay')">Test Mission Bay</button>
        <button onclick="testNeighborhood('Haight-Ashbury')">Test Haight</button>
      </div>
    </div>

    <!-- Neighborhood Billboard Overlay -->
    <div id="billboardOverlay" class="billboard-overlay">
      <button id="closeBillboard" class="billboard-close">âœ•</button>
      <div class="billboard-content">
        <img id="billboardImage" class="billboard-image" alt="Neighborhood Billboard" />
        <div id="billboardNeighborhood" class="billboard-neighborhood"></div>
      </div>
    </div>

    <canvas id="snapshot" class="visually-hidden" aria-hidden="true"></canvas>

    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script>
      // AI Keywords for detection
      const AI_KEYWORDS = [
        "ai","artificial intelligence","machine learning","deep learning","neural network",
        "algorithm","computer vision","nlp","natural language","chatbot","assistant",
        "automation","autonomous","predictive","generative","gen ai","genai",
        "large language model","llm","foundation model","transformer","gpt","chatgpt",
        "bard","gemini","claude","copilot","midjourney","stability ai","stable diffusion",
        "dalle","runway","hugging face","openai","anthropic","google ai","microsoft ai",
        "aws ai","vertex ai","sage","prompt","prompting","rag","retrieval",
        "vector database","embedding","token","training data","fine-tune","finetune",
        "inference","reinforcement learning","rlhf","computer-generated","smart",
        "intelligent","predict","optimize","automate","personalize","recommendation",
        "vision pro","edge ai","on-device ai","ai powered","ai-powered","model",
        "data science","data-driven","cognitive","digital brain","co-pilot",
        "chat","assistant","ai cloud","ai studio","ml ops","mlops","ai safety","alignment"
      ];

      // SF Neighborhood Boundaries (lat/lng coordinates)
      const NEIGHBORHOODS = {
        "Mission District": {
          bounds: [37.747, -122.427, 37.767, -122.403],
          image: "mission.jpg"
        },
        "SOMA": {
          bounds: [37.770, -122.411, 37.790, -122.392],
          image: "soma.jpg"
        },
        "Castro": {
          bounds: [37.758, -122.447, 37.769, -122.430],
          image: "castro.jpg"
        },
        "Marina": {
          bounds: [37.800, -122.449, 37.807, -122.428],
          image: "marina.jpg"
        },
        "Mission Bay": {
          bounds: [37.768, -122.395, 37.778, -122.385],
          image: "mission-bay.jpg"
        },
        "Haight-Ashbury": {
          bounds: [37.765, -122.454, 37.772, -122.441],
          image: "haight.jpg"
        }
      };

      // DOM Elements
      const els = {
        video: document.getElementById('camera'),
        scan: document.getElementById('btnScan'),
        status: document.getElementById('status'),
        snapshot: document.getElementById('snapshot'),
        billboardOverlay: document.getElementById('billboardOverlay'),
        billboardImage: document.getElementById('billboardImage'),
        billboardNeighborhood: document.getElementById('billboardNeighborhood'),
        closeBillboard: document.getElementById('closeBillboard')
      };

      // App State
      let videoStream = null;
      let currentNeighborhood = null;
      let userLocation = null;

      /**
       * Set status message with optional loading spinner
       */
      function setStatus(text, loading = false) {
        els.status.innerHTML = loading ? `<span class="spinner"></span> ${text}` : text;
      }

      /**
       * Check if coordinates are within neighborhood bounds
       */
      function isInBounds(lat, lon, bounds) {
        const [minLat, minLon, maxLat, maxLon] = bounds;
        return lat >= minLat && lat <= maxLat && lon >= minLon && lon <= maxLon;
      }

      /**
       * Detect neighborhood based on coordinates
       */
      function detectNeighborhood(coords) {
        if (!coords) return null;
        
        const { latitude, longitude } = coords;
        
        for (const [name, data] of Object.entries(NEIGHBORHOODS)) {
          if (isInBounds(latitude, longitude, data.bounds)) {
            return name;
          }
        }
        
        return null; // Not in any supported neighborhood
      }

      /**
       * Get user's current location
       */
      async function getUserLocation() {
        if (!('geolocation' in navigator)) {
          console.warn('Geolocation not supported');
          return null;
        }

        return new Promise((resolve) => {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              userLocation = position.coords;
              currentNeighborhood = detectNeighborhood(position.coords);
              console.log('ðŸ“ Location detected:', currentNeighborhood || 'Unknown neighborhood');
              resolve(currentNeighborhood);
            },
            (error) => {
              console.warn('Geolocation error:', error);
              resolve(null);
            },
            { 
              enableHighAccuracy: true, 
              timeout: 8000, 
              maximumAge: 60000 
            }
          );
        });
      }

      /**
       * Start camera stream
       */
      async function startCamera() {
        try {
          setStatus('Requesting cameraâ€¦', true);
          
          videoStream = await navigator.mediaDevices.getUserMedia({ 
            video: { facingMode: { ideal: 'environment' } }, 
            audio: false 
          });
          
          els.video.srcObject = videoStream;
          
          // Check camera facing mode and adjust mirroring
          const settings = videoStream.getVideoTracks()[0]?.getSettings?.() || {};
          if (settings.facingMode !== 'user') {
            els.video.style.transform = 'none';
          }
          
          els.scan.disabled = false;
          setStatus('Ready to scan');
          
        } catch (error) {
          console.error('Camera error:', error);
          setStatus('Camera permission denied. Please allow camera access.');
        }
      }

      /**
       * Capture video frame to canvas for OCR processing
       */
      function captureFrame() {
        const video = els.video;
        const canvas = els.snapshot;
        
        // Set canvas size based on video dimensions
        const ratio = video.videoWidth / video.videoHeight || 1.777;
        const targetWidth = Math.min(1280, video.videoWidth || 1280);
        const targetHeight = Math.round(targetWidth / ratio);
        
        canvas.width = targetWidth;
        canvas.height = targetHeight;
        
        // Draw video frame to canvas
        const ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0, targetWidth, targetHeight);
        
        return canvas;
      }

      /**
       * Extract AI keywords from text
       */
      function findAIKeywords(text) {
        const lowerText = (text || '').toLowerCase();
        const foundKeywords = [];
        
        for (const keyword of AI_KEYWORDS) {
          if (lowerText.includes(keyword.toLowerCase())) {
            foundKeywords.push(keyword);
          }
        }
        
        return foundKeywords;
      }

      /**
       * Show neighborhood billboard overlay
       */
      function showNeighborhoodBillboard(neighborhoodName) {
        if (!neighborhoodName || !NEIGHBORHOODS[neighborhoodName]) {
          console.warn('Unknown neighborhood:', neighborhoodName);
          setStatus('Location not supported yet');
          return;
        }

        const neighborhood = NEIGHBORHOODS[neighborhoodName];
        
        // Set image source with fallback
        els.billboardImage.src = neighborhood.image;
        els.billboardImage.onerror = () => {
          // Fallback: create a colored placeholder if image fails to load
          els.billboardImage.style.display = 'none';
          els.billboardNeighborhood.style.marginBottom = '0';
        };
        
        // Set neighborhood name
        els.billboardNeighborhood.textContent = neighborhoodName;
        
        // Show overlay
        els.billboardOverlay.classList.add('show');
        
        // Auto-hide after 8 seconds
        setTimeout(() => {
          hideBillboard();
        }, 8000);
        
        // Haptic feedback if available
        if (navigator.vibrate) {
          navigator.vibrate([100, 50, 100]);
        }
        
        console.log('ðŸ“º Showing billboard for:', neighborhoodName);
      }

      /**
       * Hide billboard overlay
       */
      function hideBillboard() {
        els.billboardOverlay.classList.remove('show');
      }

      /**
       * Scan billboard for AI text
       */
      async function scanBillboard() {
        setStatus('Scanning for AI textâ€¦', true);
        
        const canvas = captureFrame();
        
        try {
          // Perform OCR on captured frame
          const { data } = await Tesseract.recognize(canvas, 'eng', { 
            logger: m => { 
              if (m.status === 'recognizing text') {
                setStatus(`Analyzingâ€¦ ${(m.progress * 100).toFixed(0)}%`, true);
              }
            } 
          });
          
          const text = data?.text || '';
          const aiKeywords = findAIKeywords(text);
          
          console.log('ðŸ“ OCR Text:', text.substring(0, 100) + '...');
          console.log('ðŸ¤– AI Keywords found:', aiKeywords);
          
          if (aiKeywords.length > 0) {
            setStatus(`AI detected: ${aiKeywords[0]}`);
            
            // Show neighborhood billboard if location is known
            if (currentNeighborhood) {
              showNeighborhoodBillboard(currentNeighborhood);
            } else {
              setStatus('AI detected, but location unknown. Enable location services.');
            }
          } else {
            setStatus('No AI text detected. Try a different angle or billboard.');
          }
          
        } catch (error) {
          console.error('OCR Error:', error);
          setStatus('Scan failed. Please try again.');
        }
      }

      /**
       * Test function for development - simulate neighborhood detection
       */
      function testNeighborhood(neighborhoodName) {
        console.log('ðŸ§ª Testing neighborhood:', neighborhoodName);
        currentNeighborhood = neighborhoodName;
        showNeighborhoodBillboard(neighborhoodName);
      }

      /**
       * Initialize the application
       */
      async function init() {
        console.log('ðŸš€ Starting AI Billboard Scanner');
        
        // Get user location
        setStatus('Getting locationâ€¦', true);
        await getUserLocation();
        
        // Start camera
        await startCamera();
        
        // Event listeners
        els.scan.addEventListener('click', scanBillboard);
        els.closeBillboard.addEventListener('click', hideBillboard);
        
        // Close billboard when clicking outside
        els.billboardOverlay.addEventListener('click', (e) => {
          if (e.target === els.billboardOverlay) {
            hideBillboard();
          }
        });
        
        // Fallback touch event for iOS camera activation
        document.addEventListener('touchstart', function once() {
          document.removeEventListener('touchstart', once);
          if (!videoStream) startCamera();
        }, { passive: true });
        
        // Global error handling
        window.addEventListener('error', (e) => {
          console.error('Global error:', e.error);
        });
        
        window.addEventListener('unhandledrejection', (e) => {
          console.error('Unhandled promise rejection:', e.reason);
          e.preventDefault();
        });
        
        console.log('âœ… App initialized');
      }

      // Start the app
      init();
    </script>
  </body>
</html>
