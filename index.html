<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <meta name="theme-color" content="#0f172a" />
    <title>AI Billboard Scanner - Simple Test</title>
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

    <style>
      html, body {
        height: 100%;
        width: 100%;
        margin: 0;
        padding: 0;
        background: #000;
        color: white;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        overflow-x: hidden;
      }

      /* Full-screen camera */
      #camera {
        position: fixed;
        inset: 0;
        width: 100vw;
        height: 100vh;
        object-fit: cover;
        z-index: 0;
        background: #000;
      }

      /* Top logo */
      .logo {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1000;
        background: #a3e635;
        color: #000;
        padding: 15px 30px;
        border-radius: 8px;
        font-size: 18px;
        font-weight: bold;
      }

      /* Bottom controls */
      .controls {
        position: fixed;
        bottom: 20px;
        left: 0;
        right: 0;
        z-index: 50;
        padding: 0 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 15px;
      }

      .status {
        color: rgba(255,255,255,0.9);
        font-size: 16px;
        text-align: center;
        background: rgba(0,0,0,0.7);
        padding: 8px 16px;
        border-radius: 20px;
        min-height: 20px;
      }

      .scan-btn {
        padding: 15px 40px;
        border-radius: 25px;
        border: 2px solid white;
        background: rgba(0,0,0,0.6);
        color: white;
        font-weight: bold;
        cursor: pointer;
        font-size: 18px;
      }

      .scan-btn:disabled { 
        opacity: 0.5; 
      }

      /* Test buttons */
      .test-buttons {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: center;
      }

      .test-buttons button {
        padding: 8px 15px;
        font-size: 14px;
        border: 1px solid white;
        background: rgba(255,255,255,0.1);
        color: white;
        border-radius: 8px;
        cursor: pointer;
      }

      /* BILLBOARD IMAGE OVERLAY - THE MAIN THING WE'RE TESTING */
      .billboard-overlay {
        position: fixed;
        inset: 0;
        z-index: 9999;
        background: rgba(0, 0, 0, 0.9);
        display: none;
        align-items: center;
        justify-content: center;
        flex-direction: column;
      }

      .billboard-overlay.show {
        display: flex;
      }

      .billboard-image {
        max-width: 90vw;
        max-height: 70vh;
        border-radius: 10px;
        margin-bottom: 20px;
        border: 3px solid #a3e635;
      }

      .billboard-title {
        font-size: 28px;
        font-weight: bold;
        color: #a3e635;
        text-align: center;
        margin-bottom: 20px;
      }

      .close-btn {
        position: absolute;
        top: 30px;
        right: 30px;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: white;
        border: none;
        font-size: 24px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .spinner {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid rgba(255,255,255,0.3);
        border-top-color: #a3e635;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }

      .hidden { display: none; }

      /* Debug info */
      .debug-info {
        position: fixed;
        top: 80px;
        left: 20px;
        right: 20px;
        background: rgba(0,0,0,0.8);
        color: #a3e635;
        padding: 10px;
        border-radius: 8px;
        font-size: 12px;
        font-family: monospace;
        z-index: 2000;
        max-height: 200px;
        overflow-y: auto;
      }
    </style>
  </head>
  <body>
    <!-- Camera -->
    <video id="camera" playsinline autoplay muted></video>

    <!-- Logo -->
    <div class="logo">
      <img src="logo.png" alt="Logo" style="height: 40px; width: auto;" onerror="this.style.display='none'; this.parentElement.innerHTML='AI SCANNER';" />
    </div>

    <!-- Debug Info (hidden by default) -->
    <div id="debugInfo" class="debug-info" style="display: none;"></div>

    <!-- Controls -->
    <div class="controls">
      <div class="status" id="status">Starting...</div>
      <button id="scanBtn" class="scan-btn" disabled>üì∏ Scan for AI Text</button>
      
      <!-- Simple test buttons -->
      <div class="test-buttons">
        <button onclick="testShowImage()">üß™ Test Show Image</button>
        <button onclick="simulateAIDetection()">ü§ñ Simulate AI Detection</button>
      </div>
    </div>

    <!-- BILLBOARD OVERLAY - This is what we're trying to get working -->
    <div id="billboardOverlay" class="billboard-overlay">
      <button id="closeBtn" class="close-btn">‚úï</button>
      <div class="billboard-title">Mission District</div>
      <img id="billboardImage" class="billboard-image" src="assets/mission.jpg" alt="Mission District Billboard" />
    </div>

    <canvas id="canvas" class="hidden"></canvas>

    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script>
      // SIMPLIFIED AI KEYWORDS - just a few for testing
      const AI_KEYWORDS = [
        "ai", "artificial intelligence", "machine learning", "chatbot", "smart", "intelligent"
      ];

      // Elements
      const camera = document.getElementById('camera');
      const scanBtn = document.getElementById('scanBtn');
      const status = document.getElementById('status');
      const billboardOverlay = document.getElementById('billboardOverlay');
      const billboardImage = document.getElementById('billboardImage');
      const closeBtn = document.getElementById('closeBtn');
      const canvas = document.getElementById('canvas');
      const debugInfo = document.getElementById('debugInfo');

      let stream = null;
      let showDebug = false;

      // Debug logging function
      function debugLog(message) {
        console.log('üîç DEBUG:', message);
        if (showDebug) {
          const time = new Date().toLocaleTimeString();
          debugInfo.innerHTML += `<div>${time}: ${message}</div>`;
          debugInfo.scrollTop = debugInfo.scrollHeight;
        }
      }

      // Set status with optional loading
      function setStatus(text, loading = false) {
        status.innerHTML = loading ? `<span class="spinner"></span> ${text}` : text;
        debugLog(`Status: ${text}`);
      }

      // Toggle debug panel
      function toggleDebug() {
        showDebug = !showDebug;
        debugInfo.style.display = showDebug ? 'block' : 'none';
        debugLog(`Debug panel ${showDebug ? 'enabled' : 'disabled'}`);
      }

      // Start camera
      async function startCamera() {
        try {
          setStatus('Starting camera...', true);
          debugLog('Requesting camera access...');
          
          stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: { ideal: 'environment' } }
          });
          
          camera.srcObject = stream;
          scanBtn.disabled = false;
          setStatus('Ready to scan');
          debugLog('‚úÖ Camera started successfully');
          
        } catch (error) {
          setStatus('Camera access denied');
          debugLog(`‚ùå Camera error: ${error.message}`);
        }
      }

      // Show billboard image - THE MAIN FUNCTION WE'RE TESTING
      function showBillboardImage() {
        debugLog('üé¨ Attempting to show billboard image...');
        
        // Check if image element exists
        if (!billboardImage) {
          debugLog('‚ùå Billboard image element not found!');
          return;
        }

        // Check image source
        debugLog(`üì∏ Image src: ${billboardImage.src}`);
        
        // Show the overlay
        billboardOverlay.classList.add('show');
        debugLog('‚úÖ Billboard overlay shown');
        
        // Test if image loads
        billboardImage.onload = () => {
          debugLog('‚úÖ Image loaded successfully');
        };
        
        billboardImage.onerror = (error) => {
          debugLog(`‚ùå Image failed to load: ${error}`);
          debugLog(`‚ùå Attempted to load: ${billboardImage.src}`);
        };

        // Auto-hide after 8 seconds
        setTimeout(() => {
          hideBillboardImage();
        }, 8000);
      }

      // Hide billboard image
      function hideBillboardImage() {
        billboardOverlay.classList.remove('show');
        debugLog('üì¥ Billboard overlay hidden');
      }

      // Test function - just show the image directly
      function testShowImage() {
        debugLog('üß™ TEST: Direct image show');
        showBillboardImage();
      }

      // Simulate AI detection without OCR
      function simulateAIDetection() {
        debugLog('ü§ñ SIMULATE: AI detection flow');
        setStatus('AI text detected!');
        
        setTimeout(() => {
          showBillboardImage();
        }, 500);
      }

      // Scan for AI text - REAL OCR VERSION
      async function scanForAI() {
        setStatus('Scanning for AI text...', true);
        debugLog('üîç Starting OCR scan...');
        
        // Capture frame
        const ctx = canvas.getContext('2d');
        canvas.width = camera.videoWidth || 640;
        canvas.height = camera.videoHeight || 480;
        ctx.drawImage(camera, 0, 0, canvas.width, canvas.height);
        
        debugLog(`üìê Canvas size: ${canvas.width}x${canvas.height}`);
        
        try {
          // OCR
          debugLog('üîç Running OCR...');
          const { data } = await Tesseract.recognize(canvas, 'eng', {
            logger: m => {
              if (m.status === 'recognizing text') {
                setStatus(`Analyzing... ${(m.progress * 100).toFixed(0)}%`, true);
              }
            }
          });
          
          const text = data.text || '';
          debugLog(`üìù OCR result: "${text.substring(0, 100)}..."`);
          
          // Check for AI keywords
          const lowerText = text.toLowerCase();
          const foundKeywords = AI_KEYWORDS.filter(keyword => lowerText.includes(keyword));
          
          debugLog(`üîç Checking for AI keywords in: "${lowerText.substring(0, 50)}..."`);
          debugLog(`üéØ Found keywords: ${foundKeywords.join(', ')}`);
          
          if (foundKeywords.length > 0) {
            setStatus(`AI detected: ${foundKeywords[0]}`);
            debugLog(`‚úÖ AI DETECTED! Keywords: ${foundKeywords.join(', ')}`);
            showBillboardImage();
          } else {
            setStatus('No AI text found');
            debugLog('‚ùå No AI keywords found');
          }
          
        } catch (error) {
          setStatus('Scan failed');
          debugLog(`‚ùå OCR error: ${error.message}`);
        }
      }

      // Initialize app
      async function init() {
        debugLog('üöÄ App starting...');
        setStatus('Initializing...', true);
        
        await startCamera();
        
        // Event listeners
        scanBtn.addEventListener('click', scanForAI);
        closeBtn.addEventListener('click', hideBillboardImage);
        
        // Click outside to close
        billboardOverlay.addEventListener('click', (e) => {
          if (e.target === billboardOverlay) {
            hideBillboardImage();
          }
        });
        
        debugLog('‚úÖ App initialized');
      }

      // Start the app
      init();
    </script>
  </body>
</html>
