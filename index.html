<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <meta name="theme-color" content="#0f172a" />
    <title>AI Billboard Scanner</title>
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

    <style>
      html, body {
        height: 100%;
        width: 100%;
        margin: 0;
        padding: 0;
        background: #000;
        color: white;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        overflow-x: hidden;
      }

      /* Full-screen camera */
      #camera {
        position: fixed;
        inset: 0;
        width: 100vw;
        height: 100vh;
        object-fit: cover;
        z-index: 0;
        background: #000;
      }

      /* Top logo */
      .logo {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1000;
        background: #a3e635;
        color: #000;
        padding: 15px 30px;
        border-radius: 8px;
        font-size: 18px;
        font-weight: bold;
      }

      /* Bottom controls */
      .controls {
        position: fixed;
        bottom: 20px;
        left: 0;
        right: 0;
        z-index: 50;
        padding: 0 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
      }

      .status {
        color: rgba(255,255,255,0.8);
        font-size: 14px;
        text-align: center;
      }

      .scan-btn {
        padding: 12px 30px;
        border-radius: 25px;
        border: 2px solid white;
        background: rgba(0,0,0,0.5);
        color: white;
        font-weight: bold;
        cursor: pointer;
        font-size: 16px;
      }

      .scan-btn:disabled { 
        opacity: 0.5; 
      }

      /* Simple image overlay - THIS IS WHAT YOU WANT */
      .image-overlay {
        position: fixed;
        inset: 0;
        z-index: 9999;
        background: rgba(0, 0, 0, 0.9);
        display: none;
        align-items: center;
        justify-content: center;
        flex-direction: column;
      }

      .image-overlay.show {
        display: flex;
      }

      .neighborhood-image {
        max-width: 90vw;
        max-height: 70vh;
        border-radius: 10px;
        margin-bottom: 20px;
      }

      .neighborhood-name {
        font-size: 24px;
        font-weight: bold;
        color: #a3e635;
        text-align: center;
      }

      .close-btn {
        position: absolute;
        top: 20px;
        right: 20px;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: white;
        border: none;
        font-size: 20px;
        cursor: pointer;
      }

      /* Test buttons */
      .test-buttons {
        display: flex;
        gap: 5px;
        flex-wrap: wrap;
        justify-content: center;
      }

      .test-buttons button {
        padding: 5px 10px;
        font-size: 12px;
        border: 1px solid white;
        background: rgba(255,255,255,0.1);
        color: white;
        border-radius: 5px;
        cursor: pointer;
      }

      .spinner {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid rgba(255,255,255,0.3);
        border-top-color: #a3e635;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }

      .hidden { display: none; }
    </style>
  </head>
  <body>
    <!-- Camera -->
    <video id="camera" playsinline autoplay muted></video>

    <!-- Logo -->
    <div class="logo">
      <img src="logo.png" alt="Logo" style="height: 40px; width: auto;" onerror="this.style.display='none'; this.parentElement.innerHTML='YOUR LOGO';" />
    </div>

    <!-- Controls -->
    <div class="controls">
      <div class="status" id="status">Starting...</div>
      <button id="scanBtn" class="scan-btn" disabled>ðŸ“¸ Scan Billboard</button>
      
      <!-- Location Testing -->
      <div class="test-buttons">
        <select id="locationSelect" style="padding: 5px; margin: 5px; background: rgba(0,0,0,0.7); color: white; border: 1px solid white; border-radius: 5px;">
          <option value="">Use Real Location</option>
          <option value="Mission District">ðŸŽ¯ Force Mission District</option>
          <option value="SOMA">ðŸŽ¯ Force SOMA</option>
          <option value="Castro">ðŸŽ¯ Force Castro</option>
          <option value="Marina">ðŸŽ¯ Force Marina</option>
          <option value="Mission Bay">ðŸŽ¯ Force Mission Bay</option>
          <option value="Haight-Ashbury">ðŸŽ¯ Force Haight-Ashbury</option>
        </select>
        <button onclick="testFullFlow()">ðŸ§ª Test Full AI Detection</button>
      </div>
      
      <!-- Quick image tests -->
      <div class="test-buttons">
        <button onclick="showImage('Mission District')">ðŸ“¸ Mission</button>
        <button onclick="showImage('SOMA')">ðŸ“¸ SOMA</button>
        <button onclick="showImage('Castro')">ðŸ“¸ Castro</button>
        <button onclick="showImage('Marina')">ðŸ“¸ Marina</button>
        <button onclick="showImage('Mission Bay')">ðŸ“¸ Mission Bay</button>
        <button onclick="showImage('Haight-Ashbury')">ðŸ“¸ Haight</button>
      </div>
    </div>

    <!-- SIMPLE IMAGE OVERLAY - This is what shows instead of popup -->
    <div id="imageOverlay" class="image-overlay">
      <button id="closeBtn" class="close-btn">âœ•</button>
      <img id="neighborhoodImage" class="neighborhood-image" alt="Neighborhood" />
      <div id="neighborhoodName" class="neighborhood-name"></div>
    </div>

    <canvas id="canvas" class="hidden"></canvas>

    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <script>
      // AI Keywords
      const AI_KEYWORDS = [
        "ai", "artificial intelligence", "machine learning", "deep learning",
        "neural network", "algorithm", "computer vision", "nlp", "chatbot",
        "automation", "smart", "intelligent", "predictive", "generative"
      ];

      // Neighborhoods with image files
      const NEIGHBORHOODS = {
        "Mission District": "assets/mission.jpg",
        "SOMA": "assets/soma.jpg", 
        "Castro": "assets/castro.jpg",
        "Marina": "assets/marina.jpg",
        "Mission Bay": "assets/mission-bay.jpg",
        "Haight-Ashbury": "assets/haight.jpg"
      };

      // Neighborhood boundaries
      const BOUNDS = {
        "Mission District": [37.747, -122.427, 37.767, -122.403],
        "SOMA": [37.770, -122.411, 37.790, -122.392],
        "Castro": [37.758, -122.447, 37.769, -122.430],
        "Marina": [37.800, -122.449, 37.807, -122.428],
        "Mission Bay": [37.768, -122.395, 37.778, -122.385],
        "Haight-Ashbury": [37.765, -122.454, 37.772, -122.441]
      };

      // Elements
      const camera = document.getElementById('camera');
      const scanBtn = document.getElementById('scanBtn');
      const status = document.getElementById('status');
      const imageOverlay = document.getElementById('imageOverlay');
      const neighborhoodImage = document.getElementById('neighborhoodImage');
      const neighborhoodName = document.getElementById('neighborhoodName');
      const closeBtn = document.getElementById('closeBtn');
      const canvas = document.getElementById('canvas');
      const locationSelect = document.getElementById('locationSelect');

      let currentNeighborhood = null;
      let stream = null;
      let testMode = false;

      // Set status with optional loading
      function setStatus(text, loading = false) {
        status.innerHTML = loading ? `<span class="spinner"></span> ${text}` : text;
      }

      // Get user location and determine neighborhood
      async function getLocation() {
        // Check if we're forcing a test location
        const forcedLocation = locationSelect.value;
        if (forcedLocation) {
          console.log('ðŸŽ¯ Using forced location:', forcedLocation);
          testMode = true;
          return forcedLocation;
        }
        
        if (!navigator.geolocation) return null;
        
        return new Promise((resolve) => {
          navigator.geolocation.getCurrentPosition(
            (pos) => {
              const { latitude, longitude } = pos.coords;
              console.log('ðŸ“ Real coordinates:', latitude, longitude);
              
              // Check which neighborhood
              for (const [name, bounds] of Object.entries(BOUNDS)) {
                const [minLat, minLon, maxLat, maxLon] = bounds;
                if (latitude >= minLat && latitude <= maxLat && 
                    longitude >= minLon && longitude <= maxLon) {
                  resolve(name);
                  return;
                }
              }
              resolve(null);
            },
            () => resolve(null),
            { timeout: 5000 }
          );
        });
      }

      // Update location when dropdown changes
      function updateLocation() {
        const selected = locationSelect.value;
        if (selected) {
          currentNeighborhood = selected;
          testMode = true;
          setStatus(`ðŸŽ¯ Test Mode: ${selected}`);
          console.log('ðŸ§ª Switched to test location:', selected);
        } else {
          testMode = false;
          setStatus('Using real location...', true);
          getLocation().then(location => {
            currentNeighborhood = location;
            if (location) {
              setStatus(`ðŸ“ Real location: ${location}`);
            } else {
              setStatus('Location unknown');
            }
          });
        }
      }

      // Start camera
      async function startCamera() {
        try {
          setStatus('Starting camera...', true);
          stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: { ideal: 'environment' } }
          });
          camera.srcObject = stream;
          scanBtn.disabled = false;
          setStatus('Ready to scan');
        } catch (error) {
          setStatus('Camera access denied');
        }
      }

      // Show neighborhood image - THIS IS THE KEY FUNCTION
      function showImage(neighborhood) {
        if (!NEIGHBORHOODS[neighborhood]) {
          console.log('Unknown neighborhood:', neighborhood);
          return;
        }

        // Set the image source
        neighborhoodImage.src = NEIGHBORHOODS[neighborhood];
        
        // Set the neighborhood name
        neighborhoodName.textContent = neighborhood;
        
        // Show the overlay
        imageOverlay.classList.add('show');
        
        console.log('Showing image for:', neighborhood);
        
        // Auto-hide after 5 seconds
        setTimeout(() => {
          hideImage();
        }, 5000);
      }

      // Hide image overlay
      function hideImage() {
        imageOverlay.classList.remove('show');
      }

      // Test full AI detection flow
      function testFullFlow() {
        const selectedLocation = locationSelect.value || currentNeighborhood;
        
        if (!selectedLocation) {
          alert('Please select a test location first!');
          return;
        }
        
        console.log('ðŸ§ª Testing full AI detection flow for:', selectedLocation);
        
        // Simulate AI detection
        setStatus('ðŸ§ª Simulating AI detection...', true);
        
        setTimeout(() => {
          setStatus('ðŸ¤– AI detected! (simulated)');
          showImage(selectedLocation);
        }, 1500);
      }

      // Scan for AI text
      async function scan() {
        setStatus('Scanning...', true);
        
        // Capture frame
        const ctx = canvas.getContext('2d');
        canvas.width = camera.videoWidth;
        canvas.height = camera.videoHeight;
        ctx.drawImage(camera, 0, 0);
        
        try {
          // OCR
          const { data } = await Tesseract.recognize(canvas, 'eng');
          const text = data.text.toLowerCase();
          
          // Check for AI keywords
          const foundAI = AI_KEYWORDS.some(keyword => text.includes(keyword));
          
          if (foundAI) {
            setStatus('AI detected!');
            
            // Show neighborhood image if we know the location
            if (currentNeighborhood) {
              showImage(currentNeighborhood);
            } else {
              setStatus('AI found, but location unknown');
            }
          } else {
            setStatus('No AI text found');
          }
        } catch (error) {
          setStatus('Scan failed');
        }
      }

      // Initialize app
      async function init() {
        setStatus('Getting location...', true);
        currentNeighborhood = await getLocation();
        
        if (currentNeighborhood) {
          setStatus(`Location: ${currentNeighborhood}`, true);
        } else {
          setStatus('Location unknown', true);
        }
        
        await startCamera();
        
        // Event listeners
        scanBtn.addEventListener('click', scan);
        closeBtn.addEventListener('click', hideImage);
        locationSelect.addEventListener('change', updateLocation);
        
        // Click outside to close
        imageOverlay.addEventListener('click', (e) => {
          if (e.target === imageOverlay) hideImage();
        });
      }

      init();
    </script>
  </body>
</html>
